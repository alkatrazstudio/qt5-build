name: Build Qt


on:
  push:
    tags:
    - v*


jobs:
  build-win:
    runs-on: windows-2019

    steps:
    - name: Checkout
      uses: actions/checkout@v2
      with:
        persist-credentials: false

    - name: Set up MSYS2 PATH
      run: echo ::add-path::C:\msys64\usr\bin\
      shell: pwsh

    - name: Build
      run: ./build-win.sh
      shell: bash --login -eo pipefail "{0}"
      env:
        MSYSTEM: MINGW64
        CHERE_INVOKING: 1
        MSYS2_PATH_TYPE: inherit

    - name: Generate release notes
      shell: bash
      run: ./generate-release-notes.sh > RELEASE.md

    - name: Release
      uses: softprops/action-gh-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.RELEASE_TOKEN }}
      with:
        files: "C:/msys64/msys/msys64/home/a/*.pkg.tar.zst"


  build-osx:
    runs-on: macos-10.15

    steps:
    - name: Checkout
      uses: actions/checkout@v2
      with:
        persist-credentials: false

    - name: Build
      run: ./build-osx.sh all

    - name: Generate release notes
      run: ./generate-release-notes.sh > RELEASE.md

    - name: Release
      uses: softprops/action-gh-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.RELEASE_TOKEN }}
      with:
        files: archive/*.tar.xz


  build-linux:
    runs-on: ubuntu-20.04
    container: ubuntu:20.04

    steps:
    - name: Checkout
      uses: actions/checkout@v2
      with:
        persist-credentials: false

    - name: Build
      run: ./build-linux.sh all

    - name: Generate release notes
      run: ./generate-release-notes.sh > RELEASE.md

    - name: Release
      uses: softprops/action-gh-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.RELEASE_TOKEN }}
      with:
        files: archive/*.tar.xz
        body_path: RELEASE.md
